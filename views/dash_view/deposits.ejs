<%- include("../partials/header.ejs") %>

<div class="main-content side-content pt-0">
  <div class="main-container container-fluid">
    <div class="inner-body">
      <div id="mobileshow" class="see"></div>
      <div class="sees hide-mobile"></div>
      <h1 class="fs-5 fw-bold mb-0 text-white">Deposit</h1>
      <p>Deposit into your trading account</p>
      <br />
      <!--Row-->

      <!--Row-->
      <div class="row row-sm">
        <div class="col-md-12 col-lg-12">
          <form
            method="post"
            id="depositForm"
            action="/depositrequest"
            class="form-horizontal"
          >
            <div class="card custom-card">
              <div class="card-body">
                <h1 class="fs-6 fw-bold mb-4 text-white">Deposit methods</h1>
                <hr />

                <!-- <% if (error) { %>
                <div class="alert alert-danger"><%= error %></div>
                <% } %>  -->
                <% if (success && success.length > 0) { %>
                  <div class="alert alert-success" id="flash-success">
                    <%= success %>
                  </div>
                <% } %>
                
                <% if (errors && errors.length > 0) { %>
                  <div class="alert alert-danger" id="flash-error">
                    <ul>
                      <% errors.forEach(function(e){ %>
                        <li><%= e %></li>
                      <% }) %>
                    </ul>
                  </div>
                <% } %>
                <script>
                  setTimeout(function () {
                    var success = document.getElementById("flash-success");
                    if (success) success.style.display = "none";
                    var error = document.getElementById("flash-error");
                    if (error) error.style.display = "none";
                  }, 6000); // hides after 60 seconds
                </script>
                <p class="mb-3 text-white">
                  To make a deposit, choose your preferred method, enter an
                  amount and click process deposit.
                </p>
                <br />
                <div class="form-group mb-3">
                  <label for="" class="mb-0">Deposit Method:</label>
                  <select
                    name="paymentmethod"
                    id="deposit_method"
                    class="form-control method form-select"
                  >
                    <!-- <option disbaled selected>-- Select Coin --</option> -->
                    <option
                      data-id="1PVQ3ek5WhrMsSw7spw5cDojZyAi6aRk1S"
                      value="BTC"
                    >
                      BTC
                    </option>
                    <option
                      data-id="0x2Fe367EdaC243716531900aaaD17981CBB66882a"
                      value="ETH"
                    >
                      ETH
                    </option>
                    <option
                      data-id="0x892a621C06160656dba7E2978832e40b42Cb7221"
                      value="USDT"
                    >
                      USDT
                    </option>
                    <option data-id="." value="LTC">LTC</option>
                    <option data-id="." value="TRX">TRX</option>
                    <option data-id="." value="DOGECOIN">DOGECOIN</option>
                    <option
                      data-id="rfUumzup3x99Q1XPGGjKrXtuw9RaEFUs5Q"
                      value="XRP"
                    >
                      XRP
                    </option>
                  </select>
                </div>

                <div class="form-group mb-0">
                  <label for="" class="mb-0">Amount (<%=user.currency%>)</label>
                  <input
                    required
                    type="number"
                    class="form-control amount"
                    placeholder="10"
                    name="paket"
                    id="amount"
                  />
                  <label class="mb-0 fs-7 text-danger" class="error"></label>
                </div>
                <input
                  type="hidden"
                  name="username"
                  value="<%=user.username%>"
                />
                <!-- <button type="submit" class="btn btn-outline-primary btn-lg btn-block rounded-6 mt-4"> Process Deposit </button> -->

                <center>
                  <button
                    type="submit"
                    id="submitBTN"
                    class="btn btn-primary"
                    style="color: #fff"
                  >
                    Process Deposit
                  </button>

                  <button
                    type="submit"
                    class="btn btn-primary"
                    style="color: #fff"
                    id="r2"
                    disabled
                  >
                    <div class="spinner-border" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    <!-- {{-- <span> Processing... </span> --}} -->
                  </button>
                </center>
              </div>
            </div>
            <!-- Modal -->
            <div
              id="qrcodemodal"
              class="modal slide"
              role="dialog"
              data-backdrop="static"
              data-keyboard="false"
              tabindex="-1"
              aria-labelledby="staticBackdrop"
              aria-hidden="true"
            >
              <div class="modal-dialog pt-5">
                <!-- Modal content-->
                <div class="modal-content mt-5 p-4" style="border-radius: 1rem">
                  <div class="page-body">
                    <div class="head">
                      <h5 class="mb-4 fw-bold">Pay with Crypto</h5>
                      <hr />
                      <label class="col-form-label py-0 mt">Address:</label>
                      <div
                        class="form-control d-flex align-items-center justify-content-between mb-2"
                        style="padding-right: 10px !important"
                      >
                        <input
                          id="HTML1"
                          type="text"
                          class="deposit_address ms-2 w-75 data"
                          readonly
                        />
                        <button
                          id="HTMLButton1"
                          type="button"
                          class="btn bg-main btn-hover-effect px-2 fw-bold text-white"
                        >
                          Copy
                        </button>
                      </div>
                      <div class="p-3 border border-white my-4 rounded-10">
                        <p class="mb-0">
                          Kindly copy and make your deposit into the provided
                          address and tap the deposit button. Or scan the QR
                          Code below
                        </p>
                      </div>
                      <div class="d-flex justify-content-center">
                        <div
                          class="p-2 rounded-10"
                          style="background-color: white"
                        >
                          <div id="qrcode-container"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>

        <script>
          let HTML = document.getElementById("HTML");
          let HTMLButton = document.getElementById("HTMLButton");

          HTMLButton.onclick = function () {
            HTML.select();
            document.execCommand("copy");
            HTMLButton.innerText = "Copied!";
          };
        </script>

        <script>
          let HTML1 = document.getElementById("HTML1");
          let HTMLButton1 = document.getElementById("HTMLButton1");

          HTMLButton1.onclick = function () {
            HTML1.select();
            document.execCommand("copy");
            HTMLButton1.innerText = "Copied!";
          };
        </script>

        <div class="col-12">
          <div class="card custom-card">
            <div class="card-body">
              <h4 class="main-content-label mb-3 text-white center">
                <center>Deposit History</center>
              </h4>
              <hr />
              <div class="table-responsive">
                <table
                  class="table table-borderless table-striped table-hover text-nowrap text-md-nowrap table-hover mg-b-0"
                >
                  <thead>
                    <tr>
                      <th><center>ID</center></th>
                      <th><center>Date</center></th>
                      <th><center>Amount</center></th>
                      <th><center>Method</center></th>

                      <th><center>Status</center></th>
                    </tr>
                  </thead>

                  <tbody>
                    <!-- deposit rows inserted here by client script -->
                  </tbody>
                </table>

                <script>
                  async function loadDeposits() {
                    try {
                      const res = await fetch("/api/deposits", {
                        headers: { Accept: "application/json" },
                      });
                      if (!res.ok) throw new Error("Failed to load deposits");
                      const body = await res.json();
                      // Check if deposits array is empty
                      if (!body.success)
                        throw new Error(body.message || "Failed");
                      const tbody = document.querySelector("table tbody");
                      if (!tbody)
                        return console.error("Deposits table body not found");
                      tbody.innerHTML = "";
                      if (body.deposits.length === 0) {
                        const tbody = document.querySelector("table tbody");
                        if (!tbody)
                          return console.error("Deposits table body not found");
                        tbody.innerHTML =
                          '<br><tr><td colspan="6" class="text-center h6">No Recent Deposits</td></tr>';
                      }
                      body.deposits.forEach((d) => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                    <td><center>${d.deposittransactionid || d.id}</center></td>
                    <td><center>${
                      d.depositdate || new Date(d.createdAt).toLocaleString()
                    }</center></td>
                    <td><center><%=user.currency%> ${Number(d.amount).toFixed(
                      2
                    )}</center></td>
                    <td><center>${d.depositmethod || ""}</center></td>
                    <td><center>${d.depositstatus || ""}</center></td>
                `;
                        tbody.appendChild(tr);
                      });
                    } catch (err) {
                      console.error("Could not load deposits:", err);
                    }
                  }
                  document.addEventListener("DOMContentLoaded", loadDeposits);
                </script>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- /.content-wrapper -->
<!-- End Main Content-->

<script>
  $("#submitBTN").click(function (e) {
    e.preventDefault();
    $("#submitBTN").hide();
    $("#r2").show();
    // Get the amount value from the input field
    let amount = $("#amount").val();
    if (amount == "") {
      swal("Invalid amount!", "Input a Valid Amount", "error");
      $("#submitBTN").show();
      $("#r2").hide();
    } else if (amount < 100) {
      swal("Minimum deposit is $100", "Please deposit at least $100", "error");
      $("#r2").hide();
      $("#submitBTN").show();
    } else {
      $("#depositForm").submit();
    }

    // $("#qrcodemodal").modal('show');

    // $("#depositForm").submit()
  });
</script>

<%-include('../partials/footer')%>
